require('dotenv').config();
const workingGeminiService = require('./services/workingGeminiService');

async function testEnhancedQuizGeneration() {
  console.log('🧪 Testing Enhanced AI-Driven Quiz Generation...\n');

  const testSkills = [
    { skill: 'JavaScript', chapter: 'Chapter 1 - Variables and Functions' },
    { skill: 'Python', chapter: 'Chapter 2 - Data Structures' },
    { skill: 'React', chapter: 'Chapter 1 - Components and JSX' },
    { skill: 'HTML', chapter: 'Chapter 1 - Basic Tags' },
    { skill: 'Machine Learning', chapter: 'Chapter 1 - Introduction' }
  ];

  for (const testCase of testSkills) {
    console.log(`🎯 Testing: ${testCase.skill} - ${testCase.chapter}`);
    console.log('='.repeat(70));
    
    try {
      const startTime = Date.now();
      const quizResult = await workingGeminiService.generateQuiz(
        testCase.skill, 
        testCase.chapter, 
        'medium'
      );
      const endTime = Date.now();
      
      if (quizResult.success) {
        console.log(`✅ Quiz generated successfully in ${endTime - startTime}ms`);
        console.log(`📊 Generated by: ${quizResult.generatedBy}`);
        console.log(`🤖 AI Generated: ${quizResult.aiGenerated ? 'Yes' : 'No (Fallback)'}`);
        console.log(`📝 Topic Summary: ${quizResult.topic_summary}`);
        console.log(`🎯 Concepts: ${quizResult.concept_list?.join(', ')}`);
        console.log(`❓ Questions: ${quizResult.questions.length}`);
        
        // Analyze questions for skill relevance
        let skillSpecificCount = 0;
        let datascienceCount = 0;
        
        console.log('\n📋 Question Analysis:');
        quizResult.questions.slice(0, 3).forEach((q, index) => {
          console.log(`\n${index + 1}. ${q.question}`);
          console.log(`   Options: ${q.options.join(' | ')}`);
          console.log(`   Correct: ${q.options[q.correct]} (${q.correct})`);
          console.log(`   Concept: ${q.concept_tested}`);
          console.log(`   Explanation: ${q.explanation}`);
          
          // Check if question is skill-specific
          const questionText = (q.question + q.options.join(' ') + q.explanation).toLowerCase();
          if (questionText.includes(testCase.skill.toLowerCase())) {
            skillSpecificCount++;
          }
          if (questionText.includes('data science') || questionText.includes('statistics') || 
              questionText.includes('probability') && testCase.skill !== 'Data Science') {
            datasienceCount++;
          }
        });
        
        console.log(`\n📈 Skill Relevance: ${skillSpecificCount}/3 questions mention ${testCase.skill}`);
        console.log(`⚠️ Data Science Contamination: ${datasienceCount}/3 questions`);
        
        if (datasienceCount > 0 && testCase.skill !== 'Data Science') {
          console.log('❌ WARNING: Questions contain Data Science content for non-DS skill!');
        } else {
          console.log('✅ Questions appear to be skill-appropriate');
        }
        
      } else {
        console.log('❌ Quiz generation failed');
        console.log('Error:', quizResult.error || 'Unknown error');
      }
      
    } catch (error) {
      console.log(`❌ Test failed for ${testCase.skill}:`, error.message);
    }
    
    console.log('\n');
  }
  
  console.log('🏁 Enhanced Quiz Generation Test Complete!');
  console.log('\n💡 Expected Results:');
  console.log('   ✅ Each skill should generate skill-specific questions');
  console.log('   ✅ No Data Science content for non-DS skills');
  console.log('   ✅ Questions should test actual skill concepts');
  console.log('   ✅ Explanations should be educational and specific');
}

// Run the test
testEnhancedQuizGeneration().catch(console.error);
